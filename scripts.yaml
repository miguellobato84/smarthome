federico_dormitorio:
  alias: federico_dormitorio
  sequence:
  - service: xiaomi_miio.vacuum_clean_segment
    data:
      segments: 17
    target:
      entity_id: vacuum.federico
  mode: single
  icon: mdi:robot-vacuum
federico_volver:
  alias: federico_volver
  sequence:
  - service: vacuum.return_to_base
    data: {}
    target:
      entity_id: vacuum.federico
  mode: single
  icon: mdi:robot-vacuum
federico_limpieza:
  alias: federico_limpieza
  sequence:
  - service: xiaomi_miio.vacuum_goto
    data:
      x_coord: '18300'
      y_coord: '24700'
    target:
      entity_id: vacuum.federico
  mode: single
  icon: mdi:robot-vacuum
federico_start:
  alias: federico_start
  sequence:
  - service: vacuum.start
    data: {}
    target:
      entity_id: vacuum.federico
  mode: single
  icon: mdi:robot-vacuum
federico_estudio:
  alias: federico_estudio
  sequence:
  - service: xiaomi_miio.vacuum_clean_segment
    data:
      segments: 16
    target:
      entity_id: vacuum.federico
  mode: single
  icon: mdi:robot-vacuum
federico_pasillo:
  alias: federico_pasillo
  sequence:
  - service: xiaomi_miio.vacuum_clean_segment
    data:
      segments: 18
    target:
      entity_id: vacuum.federico
  mode: single
  icon: mdi:robot-vacuum
federico_cocina:
  alias: federico_cocina
  sequence:
  - service: xiaomi_miio.vacuum_clean_segment
    data:
      segments: 19
    target:
      entity_id: vacuum.federico
  mode: single
  icon: mdi:robot-vacuum
federico_salon:
  alias: federico_salon
  sequence:
  - service: xiaomi_miio.vacuum_clean_segment
    data:
      segments: 20
    target:
      entity_id: vacuum.federico
  mode: single
  icon: mdi:robot-vacuum
federico_location:
  alias: federico_location
  sequence:
  - service: vacuum.locate
    data: {}
    target:
      entity_id: vacuum.federico
  mode: single
  icon: mdi:robot-vacuum
radiadores_set_external:
  alias: radiadores_set_external
  description: Configura los selects a external y sincroniza temperaturas externas
  mode: single
  fields:
    option:
      description: 'Opción para los selects (por defecto: external)'
      example: external
  sequence:
  - action: select.select_option
    target:
      entity_id:
      - select.radiador_dormitorio_temperature_sensor_select
      - select.radiador_dario_temperature_sensor_select
      - select.radiador_estudio_temperature_sensor_select
      - select.radiador_entrada_temperature_sensor_select
      - select.radiador_salon_temperature_sensor_select
    data:
      option: '{{ option | default(''external'') }}'
  - action: number.set_value
    target:
      entity_id: number.radiador_dario_external_temperature_input
    data:
      value: '{{ states(''sensor.sensor_temp_dario_temperature'') | float(0) }}'
  - action: number.set_value
    target:
      entity_id: number.radiador_estudio_external_temperature_input
    data:
      value: '{{ states(''sensor.sensor_temp_estudio_temperature'') | float(0) }}'
  - action: number.set_value
    target:
      entity_id:
      - number.radiador_entrada_external_temperature_input
      - number.radiador_salon_external_temperature_input
    data:
      value: '{{ states(''sensor.sensor_temp_salon_temperature'') | float(0) }}'
  - action: number.set_value
    target:
      entity_id:
      - number.radiador_dario_temporary_mode_duration
      - number.radiador_dormitorio_temporary_mode_duration
      - number.radiador_estudio_temporary_mode_duration
      - number.radiador_entrada_temporary_mode_duration
      - number.radiador_salon_temporary_mode_duration
    data:
      value: 90
  - action: number.set_value
    target:
      entity_id:
      - number.radiador_dormitorio_temperature_accuracy
      - number.radiador_dario_temperature_accuracy
      - number.radiador_estudio_temperature_accuracy
      - number.radiador_entrada_temperature_accuracy
      - number.radiador_salon_temperature_accuracy
    data:
      value: -0.4
set_radiador:
  alias: Set Radiador
  description: Establece temperatura y ajusta apertura de válvula según diferencial
  mode: parallel
  fields:
    entity:
      description: Entidad del radiador (climate.*) o lista de entidades
      example: climate.radiador_dormitorio
    target:
      description: Temperatura objetivo (opcional, defecto final 19)
      example: 21
  variables:
    entities: '{{ [entity] if entity is string else entity }}'
    t_obj: '{{ (target | default(18, true) | float(18)) }}'
  sequence:
  - repeat:
      for_each: '{{ entities }}'
      sequence:
      - variables:
          clim_entity: '{{ repeat.item }}'
          t_act: '{{ state_attr(clim_entity, ''current_temperature'') | float(0) }}'
          diff: '{{ t_obj - t_act }}'
          valve_entity: '{{ clim_entity | replace(''climate.'', ''number.'') ~ ''_valve_opening_degree''
            }}'
      - action: logbook.log
        data:
          name: Radiador Debug
          message: 'Entity: {{ clim_entity }}, Current Temp: {{ t_act }}, Target Temp:
            {{ t_obj }}, Diff: {{ diff }}, Valve Entity: {{ valve_entity }}

            '
      - action: climate.set_temperature
        target:
          entity_id: '{{ clim_entity }}'
        data:
          temperature: '{{ t_obj }}'
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ diff >= 1 }}'
          sequence:
          - action: number.set_value
            target:
              entity_id: '{{ valve_entity }}'
            data:
              value: 100
        - conditions:
          - condition: template
            value_template: '{{ diff > 0 and diff < 1 }}'
          sequence:
          - action: number.set_value
            target:
              entity_id: '{{ valve_entity }}'
            data:
              value: 50
