on_off_light:
  alias: on_off_light
  mode: parallel
  icon: mdi:lightbulb-auto
  description: '2 levels light: on, off'
  max: 10
  variables:
    turn_on_entity:
    - light.estudio_alba_light
    kelvin: 2500
    level_max: 200
  sequence:
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ turn_on_entity | select(''is_state'', ''off'') | list
          | count == turn_on_entity | list | count }}'
      sequence:
      - service: light.turn_on
        target:
          entity_id: '{{ turn_on_entity }}'
        data:
          brightness: '{{ level_max }}'
          kelvin: '{{ kelvin }}'
    default:
    - service: light.turn_off
      target:
        entity_id: '{{ turn_on_entity }}'
      data: {}
3_level_light:
  alias: 3_level_light
  mode: parallel
  icon: mdi:lightbulb-auto
  description: '3 levels light: 70, 30, off'
  max: 10
  variables:
    turn_on_entity:
    - light.light_studio_right
    kelvin: 2500
    level_max: 170
    level_mid: 70
  sequence:
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ turn_on_entity | select(''is_state'', ''off'') | list
          | count == turn_on_entity | list | count }}'
      sequence:
      - service: light.turn_on
        target:
          entity_id: '{{ turn_on_entity }}'
        data:
          brightness: '{{ level_max }}'
          kelvin: '{{ kelvin }}'
    - conditions:
      - condition: template
        value_template: '{{ turn_on_entity | select(''is_state'', ''on'') | list |
          count == turn_on_entity | list | count }}'
      - condition: template
        value_template: '{{ turn_on_entity | map(''state_attr'', ''brightness'') |
          select(''in'', [level_max, level_max+1, level_max-1]) | list | count ==
          turn_on_entity | list | count }}'
      sequence:
      - service: light.turn_on
        target:
          entity_id: '{{ turn_on_entity }}'
        data:
          brightness: '{{ level_mid }}'
    default:
    - service: light.turn_off
      target:
        entity_id: '{{ turn_on_entity }}'
      data: {}
4_level_light:
  alias: 4_level_light
  mode: parallel
  icon: mdi:lightbulb-auto
  description: '3 levels light: 154, 170, 70, off'
  max: 10
  variables:
    turn_on_entity:
    - light.estudio_miguel_light
    - light.globito_light_level_on_off
    kelvin: 2500
    level_max: 254
    level_mid: 170
    level_low: 70
  sequence:
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ turn_on_entity | select(''is_state'', ''off'') | list
          | count == turn_on_entity | list | count }}'
      sequence:
      - service: light.turn_on
        target:
          entity_id: '{{ turn_on_entity }}'
        data:
          brightness: '{{ level_max }}'
          kelvin: '{{ kelvin }}'
    - conditions:
      - condition: template
        value_template: '{{ turn_on_entity | select(''is_state'', ''on'') | list |
          count == turn_on_entity | list | count }}'
      - condition: template
        value_template: '{{ turn_on_entity | map(''state_attr'', ''brightness'') |
          select(''in'', [level_max, level_max+1, level_max-1]) | list | count ==
          turn_on_entity | list | count }}'
      sequence:
      - service: light.turn_on
        target:
          entity_id: '{{ turn_on_entity }}'
        data:
          brightness: '{{ level_mid }}'
    - conditions:
      - condition: template
        value_template: '{{ turn_on_entity | select(''is_state'', ''on'') | list |
          count == turn_on_entity | list | count }}'
      - condition: template
        value_template: '{{ turn_on_entity | map(''state_attr'', ''brightness'') |
          select(''in'', [level_mid, level_mid+1, level_mid-1]) | list | count ==
          turn_on_entity | list | count }}'
      sequence:
      - service: light.turn_on
        target:
          entity_id: '{{ turn_on_entity }}'
        data:
          brightness: '{{ level_low }}'
    default:
    - service: light.turn_off
      target:
        entity_id: '{{ turn_on_entity }}'
      data: {}
2_level_light:
  alias: 2_level_light
  mode: parallel
  icon: mdi:lightbulb-auto
  description: Switch between the 2 level values
  max: 10
  variables:
    turn_on_entity:
    - light.estudio_miguel_light
    - light.globito_light_level_on_off
    kelvin: 2500
    level_max: 170
    level_mid: 70
  sequence:
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ turn_on_entity | select(''is_state'', ''on'') | list |
          count == turn_on_entity | list | count }}'
      - condition: template
        value_template: '{{ turn_on_entity | map(''state_attr'', ''brightness'') |
          select(''=='', level_max) | list | count == turn_on_entity | list | count
          }}'
      sequence:
      - service: light.turn_on
        target:
          entity_id: '{{ turn_on_entity }}'
        data:
          brightness: '{{ level_mid }}'
    default:
    - service: light.turn_on
      target:
        entity_id: '{{ turn_on_entity }}'
      data:
        brightness: '{{ level_max }}'
federico_dormitorio:
  alias: federico_dormitorio
  sequence:
  - service: xiaomi_miio.vacuum_clean_segment
    data:
      segments: 17
    target:
      entity_id: vacuum.federico
  mode: single
  icon: mdi:robot-vacuum
federico_volver:
  alias: federico_volver
  sequence:
  - service: vacuum.return_to_base
    data: {}
    target:
      entity_id: vacuum.federico
  mode: single
  icon: mdi:robot-vacuum
federico_limpieza:
  alias: federico_limpieza
  sequence:
  - service: xiaomi_miio.vacuum_goto
    data:
      x_coord: '18300'
      y_coord: '24700'
    target:
      entity_id: vacuum.federico
  mode: single
  icon: mdi:robot-vacuum
federico_start:
  alias: federico_start
  sequence:
  - service: vacuum.start
    data: {}
    target:
      entity_id: vacuum.federico
  mode: single
  icon: mdi:robot-vacuum
federico_estudio:
  alias: federico_estudio
  sequence:
  - service: xiaomi_miio.vacuum_clean_segment
    data:
      segments: 16
    target:
      entity_id: vacuum.federico
  mode: single
  icon: mdi:robot-vacuum
federico_pasillo:
  alias: federico_pasillo
  sequence:
  - service: xiaomi_miio.vacuum_clean_segment
    data:
      segments: 18
    target:
      entity_id: vacuum.federico
  mode: single
  icon: mdi:robot-vacuum
federico_cocina:
  alias: federico_cocina
  sequence:
  - service: xiaomi_miio.vacuum_clean_segment
    data:
      segments: 19
    target:
      entity_id: vacuum.federico
  mode: single
  icon: mdi:robot-vacuum
federico_salon:
  alias: federico_salon
  sequence:
  - service: xiaomi_miio.vacuum_clean_segment
    data:
      segments: 20
    target:
      entity_id: vacuum.federico
  mode: single
  icon: mdi:robot-vacuum
federico_location:
  alias: federico_location
  sequence:
  - service: vacuum.locate
    data: {}
    target:
      entity_id: vacuum.federico
  mode: single
  icon: mdi:robot-vacuum
debugger:
  alias: debugger
  variables:
    action: 170
    value: 70
  sequence:
  - stop: action={{action}}, value={{value}}
  mode: parallel
radiadores_set_external:
  alias: radiadores_set_external
  description: Configura los selects a external y sincroniza temperaturas externas
  mode: single
  fields:
    option:
      description: 'Opción para los selects (por defecto: external)'
      example: external
  sequence:
  - action: select.select_option
    target:
      entity_id:
      - select.radiador_dormitorio_temperature_sensor_select
      - select.radiador_dario_temperature_sensor_select
      - select.radiador_estudio_temperature_sensor_select
      - select.radiador_entrada_temperature_sensor_select
      - select.radiador_salon_temperature_sensor_select
    data:
      option: '{{ option | default(''external'') }}'
  - action: number.set_value
    target:
      entity_id: number.radiador_dormitorio_external_temperature_input
    data:
      value: '{{ states(''sensor.sensor_temp_dormitorio_temperature'') | float(0)
        }}'
  - action: number.set_value
    target:
      entity_id: number.radiador_dario_external_temperature_input
    data:
      value: '{{ states(''sensor.sensor_temp_dario_temperature'') | float(0) }}'
  - action: number.set_value
    target:
      entity_id: number.radiador_estudio_external_temperature_input
    data:
      value: '{{ states(''sensor.sensor_temp_estudio_temperature'') | float(0) }}'
  - action: number.set_value
    target:
      entity_id:
      - number.radiador_entrada_external_temperature_input
      - number.radiador_salon_external_temperature_input
    data:
      value: '{{ states(''sensor.sensor_temp_salon_temperature'') | float(0) }}'
  - action: number.set_value
    target:
      entity_id:
      - number.radiador_dario_temporary_mode_duration
      - number.radiador_dormitorio_temporary_mode_duration
      - number.radiador_estudio_temporary_mode_duration
      - number.radiador_entrada_temporary_mode_duration
      - number.radiador_salon_temporary_mode_duration
    data:
      value: 90
set_radiador:
  alias: Set Radiador
  description: Establece temperatura y ajusta apertura de válvula según diferencial
  mode: parallel
  fields:
    entity:
      description: Entidad del radiador (climate.*) o lista de entidades
      example: climate.radiador_dormitorio
    target:
      description: Temperatura objetivo (opcional, defecto final 19)
      example: 21
  variables:
    entities: '{{ [entity] if entity is string else entity }}'
    t_obj: '{{ (target | default(18, true) | float(18)) }}'
  sequence:
  - repeat:
      for_each: '{{ entities }}'
      sequence:
      - variables:
          clim_entity: '{{ repeat.item }}'
          t_act: '{{ state_attr(clim_entity, ''current_temperature'') | float(0) }}'
          diff: '{{ t_obj - t_act }}'
          valve_entity: '{{ clim_entity | replace(''climate.'', ''number.'') ~ ''_valve_opening_degree''
            }}'
      - action: logbook.log
        data:
          name: Radiador Debug
          message: 'Entity: {{ clim_entity }}, Current Temp: {{ t_act }}, Target Temp:
            {{ t_obj }}, Diff: {{ diff }}, Valve Entity: {{ valve_entity }}

            '
      - action: climate.set_temperature
        target:
          entity_id: '{{ clim_entity }}'
        data:
          temperature: '{{ t_obj }}'
      - choose:
        - conditions:
          - condition: template
            value_template: '{{ diff >= 1 }}'
          sequence:
          - action: number.set_value
            target:
              entity_id: '{{ valve_entity }}'
            data:
              value: 100
        - conditions:
          - condition: template
            value_template: '{{ diff > 0 and diff < 1 }}'
          sequence:
          - action: number.set_value
            target:
              entity_id: '{{ valve_entity }}'
            data:
              value: 50
